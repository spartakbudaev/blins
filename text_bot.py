#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Telegram Ğ±Ğ¾Ñ‚Ğ° "Ğ‘Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ Ğ±Ğ°ÑˆĞ½Ñ"
"""

import os
import logging
import random
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€
active_games = {}

# Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°ÑˆĞ½Ğ¸
PANCAKE_EMOJI = "ğŸ¥"
PLATE_EMOJI = "ğŸ½ï¸"

def start(update: Update, context: CallbackContext) -> None:
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ /start."""
    user = update.effective_user
    update.message.reply_text(
        f"ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {user.first_name}! ğŸ‘‹\n\n"
        f"Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¸Ğ³Ñ€Ñƒ 'Ğ‘Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ Ğ±Ğ°ÑˆĞ½Ñ'!\n\n"
        f"ĞĞ°Ğ¶Ğ¼Ğ¸ /play, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ."
    )

def play_command(update: Update, context: CallbackContext) -> None:
    """ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ /play."""
    user_id = update.effective_user.id
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    active_games[user_id] = {
        "score": 0,
        "tower_height": 0,
        "game_over": False
    }
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ "Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ"
    keyboard = [
        [InlineKeyboardButton("Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ", callback_data="play_game")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ñ‹
    message = update.message.reply_text(
        f"{PLATE_EMOJI}\n\nĞ¡Ñ‡Ñ‘Ñ‚: 0",
        reply_markup=reply_markup
    )

def button_callback(update: Update, context: CallbackContext) -> None:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº."""
    query = update.callback_query
    query.answer()
    
    user_id = update.effective_user.id
    
    if query.data == "play_game":
        if user_id in active_games:
            game = active_games[user_id]
            
            # Ğ•ÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ° ÑƒĞ¶Ğµ Ğ¾ĞºĞ¾Ğ½Ñ‡ĞµĞ½Ğ°, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼
            if game["game_over"]:
                return
            
            # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‡ĞµÑ‚
            game["score"] += 1
            game["tower_height"] += 1
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ°ÑÑŒ Ğ»Ğ¸ Ğ¸Ğ³Ñ€Ğ°
            game_over = False
            
            # Ğ¨Ğ°Ğ½Ñ Ğ½Ğ° Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ±Ğ°ÑˆĞ½Ğ¸ ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ñ Ğ²Ñ‹ÑĞ¾Ñ‚Ğ¾Ğ¹
            fall_chance = min(0.05 * (game["tower_height"] // 5), 0.5)
            
            if game["tower_height"] > 1 and random.random() < fall_chance:
                game_over = True
                game["game_over"] = True
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¸Ğ³Ñ€Ñ‹
            keyboard = [
                [InlineKeyboardButton("Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ", callback_data="play_game")]
            ]
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°ÑˆĞ½Ğ¸
            tower = PANCAKE_EMOJI * game["tower_height"]
            
            if game_over:
                keyboard = [
                    [InlineKeyboardButton("ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°", callback_data="new_game")]
                ]
                caption = f"ğŸ’¥ Ğ‘Ğ°ÑˆĞ½Ñ ÑƒĞ¿Ğ°Ğ»Ğ°! ğŸ’¥\n\n{PLATE_EMOJI}\n\nĞ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‡Ñ‘Ñ‚: {game['score']}"
            else:
                caption = f"{tower}\n{PLATE_EMOJI}\n\nĞ¡Ñ‡Ñ‘Ñ‚: {game['score']}"
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ³Ñ€Ñ‹
            query.edit_message_text(
                text=caption,
                reply_markup=reply_markup
            )
    
    elif query.data == "new_game":
        # ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¸Ğ³Ñ€Ñƒ
        active_games[user_id] = {
            "score": 0,
            "tower_height": 0,
            "game_over": False
        }
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ "Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ"
        keyboard = [
            [InlineKeyboardButton("Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ", callback_data="play_game")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ³Ñ€Ñ‹
        query.edit_message_text(
            text=f"{PLATE_EMOJI}\n\nĞ¡Ñ‡Ñ‘Ñ‚: 0",
            reply_markup=reply_markup
        )

def main():
    """Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ°."""
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    load_dotenv()
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
    token = os.getenv("BOT_TOKEN")
    if not token:
        logger.error("Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ!")
        exit(1)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Updater Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ ĞµĞ¼Ñƒ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°
    updater = Updater(token)
    
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²
    dispatcher = updater.dispatcher
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("play", play_command))
    dispatcher.add_handler(CallbackQueryHandler(button_callback))
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    print("=" * 50)
    print("Ğ—Ğ°Ğ¿ÑƒÑĞº Telegram Ğ±Ğ¾Ñ‚Ğ° 'Ğ‘Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ Ğ±Ğ°ÑˆĞ½Ñ' (Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)")
    print("=" * 50)
    print("\nĞ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ctrl+C Ğ´Ğ»Ñ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸.")
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°
    updater.start_polling()
    
    # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ Ctrl+C
    updater.idle()

if __name__ == "__main__":
    main() 